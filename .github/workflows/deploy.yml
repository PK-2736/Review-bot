name: Deploy to Oracle Ubuntu

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          TODOIST_API_TOKEN: ${{ secrets.TODOIST_API_TOKEN }}
          DEFAULT_PROJECT_NAME: ${{ secrets.DEFAULT_PROJECT_NAME || 'å¾©ç¿’ã‚¿ã‚¹ã‚¯' }}
        run: |
          ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            
            echo "ğŸ“¦ Deploying Review-bot..."
            
            # Node.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¥ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs
            fi
            
            # Git ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if ! command -v git &> /dev/null; then
              echo "ğŸ“¦ Installing Git..."
              sudo apt install -y git
            fi
            
            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ï¼ˆãªã‘ã‚Œã°ã‚¯ãƒ­ãƒ¼ãƒ³ï¼‰
            if [ -d "$HOME/Review-bot" ]; then
              cd $HOME/Review-bot
              echo "ğŸ”„ Pulling latest changes..."
              git pull origin main
            else
              echo "ğŸ“¥ Cloning repository..."
              cd $HOME
              git clone https://github.com/${{ github.repository }}.git
              cd Review-bot
            fi
            
            # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            echo "ğŸ“š Installing dependencies..."
            npm install --production
            
            # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
            echo "ğŸ” Creating .env file..."
            cat > .env << 'EOF'
DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
TODOIST_API_TOKEN=${{ secrets.TODOIST_API_TOKEN }}
DEFAULT_PROJECT_NAME=${{ secrets.DEFAULT_PROJECT_NAME || 'å¾©ç¿’ã‚¿ã‚¹ã‚¯' }}
EOF
            
            # PM2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Installing PM2..."
              sudo npm install -g pm2
            fi
            
            # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•/å†èµ·å‹•
            echo "ğŸš€ Starting/Restarting application with PM2..."
            pm2 restart ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            
            # PM2ã®è‡ªå‹•èµ·å‹•è¨­å®šã‚’ä¿å­˜
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š Application status:"
            pm2 list
          ENDSSH

      - name: Deployment notification
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
